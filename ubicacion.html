<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LuxDetailing Center — Ubicación</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
<header class="site-header py-2 border-bottom">
  <div class="container d-flex align-items-center justify-content-between">
    <a href="index.html" class="d-flex align-items-center text-white text-decoration-none">
      <img src="https://pub-bd7613c8c4cf4633acde18714ce2b3f3.r2.dev/images/icono.jpg" alt="Logo LuxDetailing Center" width="36" height="36" class="me-2 rounded-circle">
      <span class="fw-bold">LuxDetailing Center</span>
    </a>
  </div>
</header>

<nav class="navbar navbar-expand-lg bg-white sticky-top shadow-sm">
  <div class="container">
    <a class="navbar-brand d-lg-none" href="#">Menú</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"><span class="navbar-toggler-icon"></span></button>
    <div class="collapse navbar-collapse" id="mainNav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link " href="index.html">Home</a></li>
        <li class="nav-item"><a class="nav-link " href="historia.html">Historia</a></li>
        <li class="nav-item"><a class="nav-link " href="servicios.html">Servicios</a></li>
        <li class="nav-item"><a class="nav-link " href="galeria.html">Galería</a></li>
        <li class="nav-item"><a class="nav-link " href="multimedia.html">Multimedia</a></li>
        <li class="nav-item"><a class="nav-link active" href="ubicacion.html">Ubicación</a></li>
        <li class="nav-item"><a class="nav-link " href="contacto.html">Contacto</a></li>
        <li class="nav-item"><a class="nav-link " href="acerca.html">Acerca</a></li>
        <li class="nav-item"><a class="nav-link " href="autor.html">Autor</a></li>
      </ul>
      <div class="d-flex gap-2">
        <a class="btn btn-wa btn-sm" target="_blank" href="https://wa.me/50684529792">WhatsApp</a>
      </div>
    </div>
  </div>
</nav>

<main class="container py-4">
  <h1 class="mb-1">Cómo llegar</h1>

  <!-- Estado / mensajes -->
  <div id="ubi-status" class="alert alert-info py-2 px-3 small mb-3">
    Intentando obtener tu ubicación actual…
  </div>

  <div class="row g-3">
    <div class="col-lg-8">
      <div id="map" style="height:480px" class="rounded-3 shadow-sm"></div>
    </div>
    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">Ruta más cercana</h5>
          <p class="small">
            Destino fijo: <strong>Costa Rica, Alajuela, Guácima Abajo, Calle Los Laureles</strong>. 
            Se marcará tu ubicación como origen (si autorizas).
          </p>

          <div class="d-flex gap-2 mb-2">
            <button id="btn-geo" type="button" class="btn btn-outline-primary btn-sm">
              Usar mi ubicación
            </button>
          </div>

          <div id="panelRuta" class="small"></div>

          <div class="d-grid gap-2 mt-3">
            <a id="btnGMaps" class="btn btn-primary d-inline-flex align-items-center justify-content-center gap-2" target="_blank" rel="noopener"
               href="https://www.google.com/maps/dir/?api=1&destination=Costa%20Rica%2C%20Alajuela%2C%20Gu%C3%A1cima%20Abajo%2C%20Calle%20Los%20Laureles">
              <img src="https://pub-bd7613c8c4cf4633acde18714ce2b3f3.r2.dev/images/maps.jpg" alt="Google Maps" width="18" height="18"><span>Abrir en Maps</span>
            </a>
            <a id="btnWaze" class="btn btn-dark d-inline-flex align-items-center justify-content-center gap-2" target="_blank" rel="noopener"
               href="https://waze.com/ul?navigate=yes">
              <img src="https://pub-bd7613c8c4cf4633acde18714ce2b3f3.r2.dev/images/waze.jpg" alt="Waze" width="18" height="18"><span>Abrir en Waze</span>
            </a>
          </div>

        </div>
      </div>
    </div>
  </div>
</main>

<footer class="mt-0">
  <div class="container py-4">
    <div class="row g-3 align-items-center">
      <div class="col-12 small text-center">
        <div class="d-inline-flex align-items-center gap-3">
          <span>Síguenos:</span>
          <a href="https://www.instagram.com/lux_detailingcarwsh?igsh=MnBrNWcwdmpkMTV6" target="_blank" rel="noopener" class="d-inline-flex align-items-center gap-1">
            <img src="https://pub-bd7613c8c4cf4633acde18714ce2b3f3.r2.dev/images/instagram.jpg" alt="Instagram" width="18" height="18"> <span>Instagram</span>
          </a>
          <span>·</span>
          <a href="https://wa.me/50684529792" target="_blank" rel="noopener" class="d-inline-flex align-items-center gap-1">
            <img src="https://pub-bd7613c8c4cf4633acde18714ce2b3f3.r2.dev/images/whatsapp.jpg" alt="WhatsApp" width="18" height="18"> <span>WhatsApp</span>
          </a>
        </div>
      </div>
      <div class="col-12 text-center small mt-2">© <span id="year"></span> LuxDetailing Center — <a class="mx-2" href="acerca.html">Acerca</a>·<a class="mx-2" href="contacto.html">Contacto</a>·<a class="mx-2" href="index.html">Home</a></div>
    </div>
  </div>
</footer>

<script>document.getElementById('year').textContent=new Date().getFullYear();</script>
<script src="tools/config.js"></script>

<script>
  // --------- Config y constantes ----------
  const DESTINO_ADDRESS = "Costa Rica, Alajuela, Guácima Abajo, Calle Los Laureles";
  const FALLBACK_DEST   = {lat:9.958909, lng:-84.264752}; // Cerca de La Guácima
  const statusEl = document.getElementById('ubi-status');
  const btnGeo   = document.getElementById('btn-geo');
  const btnGMaps = document.getElementById('btnGMaps');
  const btnWaze  = document.getElementById('btnWaze');

  let userLL = null;   // {lat,lng}
  let destLL = null;   // {lat,lng} cuando lo tengamos

  function setStatus(msg, type='info'){
    statusEl.className = 'alert alert-' + type + ' py-2 px-3 small mb-3';
    statusEl.textContent = msg;
  }

  function setLinks(){
    // Google Maps: si tenemos userLL, la usamos; si no, "My Location"
    const origin = userLL ? (userLL.lat + ',' + userLL.lng) : 'My+Location';
    const gUrl = 'https://www.google.com/maps/dir/?api=1'
               + '&origin=' + encodeURIComponent(origin)
               + '&destination=' + encodeURIComponent(DESTINO_ADDRESS);
    btnGMaps.href = gUrl;

    // Waze: toma el origen del dispositivo; le pasamos solo el destino (lat,lng si lo tenemos)
    if(destLL){
      btnWaze.href = 'https://waze.com/ul?ll=' + destLL.lat + ',' + destLL.lng + '&navigate=yes';
    }else{
      btnWaze.href = 'https://waze.com/ul?q=' + encodeURIComponent(DESTINO_ADDRESS) + '&navigate=yes';
    }
  }

  // --------- Flujo Google Maps (si hay API KEY) ----------
  function initGoogle(){
    const KEY = (window.__LUX_CONFIG__ && (window.__LUX_CONFIG__.GOOGLE_MAPS_API_KEY||'').trim()) || '';
    if(!KEY) return false; // no hay key -> usaremos Leaflet

    window.initMap = function(){
      const map = new google.maps.Map(document.getElementById('map'), {center:FALLBACK_DEST, zoom: 14});
      const geocoder    = new google.maps.Geocoder();
      const dirService  = new google.maps.DirectionsService();
      const dirRenderer = new google.maps.DirectionsRenderer({suppressMarkers:true});
      dirRenderer.setMap(map);
      dirRenderer.setPanel(document.getElementById('panelRuta'));
      const bounds = new google.maps.LatLngBounds();

      // Geocodificamos destino
      geocoder.geocode({ address: DESTINO_ADDRESS }, (results, status) => {
        let destLatLng;
        if (status === 'OK' && results[0]) {
          destLatLng = results[0].geometry.location;
        } else {
          destLatLng = new google.maps.LatLng(FALLBACK_DEST.lat, FALLBACK_DEST.lng);
        }
        destLL = { lat: destLatLng.lat(), lng: destLatLng.lng() };
        const destMarker = new google.maps.Marker({position: destLatLng, map, title: 'Destino'});
        const iw = new google.maps.InfoWindow({ content: `<div><strong>Destino</strong><br>${DESTINO_ADDRESS}</div>` });
        destMarker.addListener('click', ()=>iw.open({anchor:destMarker, map}));
        bounds.extend(destLatLng);
        map.fitBounds(bounds);
        setLinks(); // prepara Maps/Waze con destino fijo

        function routeFrom(originLatLng){
          // Marcador de usuario
          new google.maps.Marker({
            position: originLatLng, map, title: 'Tu ubicación',
            icon: { path: google.maps.SymbolPath.CIRCLE, scale: 6, fillColor: '#0ea5e9', fillOpacity: 1, strokeColor: '#0b1220', strokeWeight: 1 }
          });
          bounds.extend(originLatLng);
          bounds.extend(destLatLng);
          map.fitBounds(bounds);

          // Ruta
          dirService.route({
            origin: originLatLng,
            destination: DESTINO_ADDRESS,
            travelMode: google.maps.TravelMode.DRIVING
          }).then(r => {
            dirRenderer.setDirections(r);
            const leg = r.routes[0]?.legs?.[0];
            if(leg){
              const km  = (leg.distance.value/1000).toFixed(1);
              const min = Math.round(leg.duration.value/60);
              document.getElementById('panelRuta').innerHTML = `<strong>Distancia:</strong> ${km} km · <strong>Tiempo aprox:</strong> ${min} min`;
            }
          }).catch(()=>{});

          // Enlaces con origen real
          userLL = { lat: originLatLng.lat, lng: originLatLng.lng };
          setLinks();
          setStatus('Ubicación detectada. Listo para calcular ruta.', 'success');
        }

        // Pedimos geolocalización (auto)
        requestGeolocation()
          .then(routeFrom)
          .catch(()=>{ setStatus('No se pudo obtener tu ubicación automáticamente. Pulsa "Usar mi ubicación".', 'warning'); });
      });
    };

    const s=document.createElement('script');
    s.src = 'https://maps.googleapis.com/maps/api/js?key='+encodeURIComponent(KEY)+'&callback=initMap';
    s.async=true; s.defer=true; document.head.appendChild(s);
    return true;
  }

  // --------- Fallback Leaflet + OSRM ----------
  async function initLeaflet(){
    // Carga de Leaflet
    const css=document.createElement('link'); css.rel='stylesheet'; css.href='https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
    document.head.appendChild(css);
    await new Promise(res=>{
      const js=document.createElement('script'); js.src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'; js.onload=res; document.body.appendChild(js);
    });

    const map = L.map('map').setView([FALLBACK_DEST.lat, FALLBACK_DEST.lng], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

    // Geocodificamos destino con Nominatim
    destLL = await geocodeNominatim(DESTINO_ADDRESS) || FALLBACK_DEST;
    const destMarker = L.marker([destLL.lat, destLL.lng], {title:'Destino'}).bindPopup(`<strong>Destino</strong><br>${DESTINO_ADDRESS}`);
    destMarker.addTo(map).openPopup();

    setLinks();

    let routeLine = null;
    const layers = [destMarker];

    function fit(){
      const g = L.featureGroup(layers);
      if(layers.length) map.fitBounds(g.getBounds(), {padding:[20,20]});
    }

    function drawRouteFrom(o){
      const userMarker = L.marker([o.lat, o.lng], {title:'Tu ubicación'}).bindPopup('Tu ubicación');
      userMarker.addTo(map); layers.push(userMarker);
      // OSRM pública (puede rate-limitar)
      const url = `https://router.project-osrm.org/route/v1/driving/${o.lng},${o.lat};${destLL.lng},${destLL.lat}?overview=full&geometries=geojson`;
      fetch(url).then(r=>r.json()).then(d=>{
        if(d && d.routes && d.routes[0]){
          const r=d.routes[0];
          const coords=r.geometry.coordinates.map(c=>[c[1],c[0]]);
          if(routeLine) map.removeLayer(routeLine);
          routeLine = L.polyline(coords, {color:'#0ea5e9', weight:5}).addTo(map);
          layers.push(routeLine);
          const km=(r.distance/1000).toFixed(1); const min=Math.round(r.duration/60);
          document.getElementById('panelRuta').innerHTML = `<strong>Distancia:</strong> ${km} km · <strong>Tiempo aprox:</strong> ${min} min`;
        }
        userLL = {lat:o.lat, lng:o.lng};
        setLinks();
        setStatus('Ubicación detectada. Listo para calcular ruta.', 'success');
        fit();
      }).catch(()=>{
        setStatus('No se pudo trazar la ruta automáticamente. Puedes usar los botones de Maps/Waze.', 'warning');
        fit();
      });
    }

    // Intento automático
    requestGeolocation()
      .then(drawRouteFrom)
      .catch(()=>{ setStatus('No se pudo obtener tu ubicación automáticamente. Pulsa "Usar mi ubicación".', 'warning'); fit(); });

    // Botón manual
    btnGeo.addEventListener('click', ()=> {
      requestGeolocation().then(drawRouteFrom).catch(()=>{
        setStatus('No se pudo obtener tu ubicación. Verifica permisos del navegador.', 'danger');
      });
    });
  }

  // --------- Utilidades comunes ----------
  function requestGeolocation(){
    return new Promise((resolve, reject)=>{
      if(!navigator.geolocation) return reject(new Error('no-geoloc'));
      navigator.geolocation.getCurrentPosition(pos=>{
        resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude });
      }, err=>{
        reject(err);
      }, { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
    });
  }

  async function geocodeNominatim(query){
    try{
      const r = await fetch('https://nominatim.openstreetmap.org/search?format=json&limit=1&q=' + encodeURIComponent(query), {headers:{'Accept-Language':'es-CR'}});
      const j = await r.json();
      if (j && j[0]) return { lat: parseFloat(j[0].lat), lng: parseFloat(j[0].lon) };
    }catch(_){}
    return null;
  }

  // --------- Inicio ----------
  (function start(){
    setStatus('Intentando obtener tu ubicación actual…', 'info');
    // Botón manual (algunos navegadores requieren gesto del usuario)
    if(btnGeo){
      btnGeo.addEventListener('click', ()=>{
        requestGeolocation().then(coords=>{
          userLL = coords;
          setLinks(); // Aunque no haya mapa cargado aún, actualizamos enlaces
          setStatus('Ubicación detectada. Listo para calcular ruta.', 'success');
        }).catch(()=>{
          setStatus('No se pudo obtener tu ubicación. Verifica permisos del navegador.', 'danger');
        });
      });
    }
    // Intentamos Google Maps si hay KEY, sino Leaflet
    const usingGoogle = initGoogle();
    if(!usingGoogle){ initLeaflet(); }
  })();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>document.getElementById('year').textContent=new Date().getFullYear();</script>
</body>
</html>
